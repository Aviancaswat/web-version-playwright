const getResponseModel = useCallback(
        async (e: React.KeyboardEvent<HTMLTextAreaElement>) => {

            if (e.key === "Enter" && !e.shiftKey && questionUser.trim() !== "") {
                e.preventDefault();

                const userMessage: Messages = {
                    role: "user",
                    message: questionUser,
                    timestamp: new Date().toISOString(),
                };

                await ConversationService.addMessage(conversationId!, userMessage);
                await ConversationService.updateConversation(conversationId!, {
                    title: userMessage.message,
                });

                setLoading(true);
                setQuestionUser("");

                try {
                    const responseAgent = await APAService.generateContentDashboard(
                        JSON.stringify(dashboardDataAgentAvianca),
                        userMessage.message
                    );

                    const newMessages: Messages[] = [];

                    const resultFunctionCall: any = responseAgent.output.find(
                        (e: any) => e.type === "function_call_result"
                    );

                    if (resultFunctionCall) {
                        const responseFunctionCallReport = resultFunctionCall?.output;
                        const textResultReport = responseFunctionCallReport?.text;

                        if (textResultReport) {
                            const result = JSON.parse(textResultReport);

                            if (result.success) {
                                newMessages.push({
                                    role: "agent",
                                    message: result?.message ?? "",
                                    timestamp: new Date().toISOString(),
                                });
                            }
                        }
                    }

                    const responseCallFunctionImage: any = responseAgent?.output.find(
                        (e: any) =>
                            e.type === "hosted_tool_call" && e.name === "image_generation_call"
                    );

                    if (responseCallFunctionImage?.output) {
                        newMessages.push({
                            role: "agent",
                            message: "",
                            timestamp: new Date().toISOString(),
                            imageContent: responseCallFunctionImage.output,
                        });
                    }

                    if (responseAgent.finalOutput && newMessages.length === 0) {
                        newMessages.push({
                            role: "agent",
                            message: responseAgent.finalOutput,
                            timestamp: new Date().toISOString(),
                        });
                    } else if (responseAgent.finalOutput && newMessages.length > 0) {
                        newMessages[0].message =
                            responseAgent.finalOutput + "\n\n" + newMessages[0].message;
                    }

                    for (const msg of newMessages) {
                        await ConversationService.addMessage(conversationId!, msg);
                    }

                } catch (error) {
                    console.error("Error al obtener respuesta:", error);

                    const errorMsg: Messages = {
                        role: "agent",
                        message: "Lo siento, ocurri√≥ un error al procesar tu solicitud.",
                        timestamp: new Date().toISOString(),
                    };

                    await ConversationService.addMessage(conversationId!, errorMsg);

                } finally {
                    setLoading(false);
                }
            }
        },
        [questionUser, dashboardDataAgentAvianca, conversationId]
    );



import { Avatar, Box, Heading } from "@chakra-ui/react";
import LogoAv from "../../assets/avianca-logo-desk.png";
import ShinyTextAgent from "../../components/animations/agent-dashboard/shinyEffectComponent";
import FadeAnimationText from "../../components/transitions/FadeText";
import type { Messages } from "./ChatAgentPage";
import MessageAgentUI from "./MessageAgent";
import MessageUserUI from "./MessageUser";

interface MessageContainerProps {
    messages: Messages[],
    isLoading: boolean,
    statusStream: boolean,
}

//Obteniendo colores del mensaje
const colors = [["orange.100", "orange.600"], ["cyan.100", "blue.600"]]
const colorRandom = colors[Math.floor(Math.random() * colors.length)];

export const MessageContainer: React.FC<MessageContainerProps> = ({ messages, isLoading, statusStream }) => {

    return (
        <>
            {
                messages.map((msg, index) => (
                    <>
                        <FadeAnimationText
                            key={index}
                            marginBottom={msg.htmlContent ? 10 : 4}
                            display="flex"
                            flexDirection={msg.role === "user" ? "row-reverse" : "row"}
                            alignItems="flex-start"
                            className="chat-ai"
                        >
                            {
                                msg.role === "user" ? <MessageUserUI msg={msg} msgColor={colorRandom} /> : <MessageAgentUI {...msg} />
                            }
                        </FadeAnimationText>

                        {/* <FadeAnimationText display={"flex"} justifyContent={"center"}>
                            {
                                msg.imageContent && (
                                    <Box display={"flex"} flexDirection={"column"}>
                                        <Card maxW={"lg"}>
                                            <CardBody>
                                                <Image
                                                    src={`data:image/png;base64,${msg.imageContent}`}
                                                    alt='generate imagen agent'
                                                    borderRadius='lg'
                                                    maxH={400}
                                                />
                                            </CardBody>
                                        </Card>
                                        <Box display={"flex"} gap={1} justifyContent={"flex-end"} mt={1}>
                                            <PreviewImageGenerateAgent imageContent={msg.imageContent} />
                                            <Button
                                                size={"sm"}
                                                onClick={() => {
                                                    const enlace = document.createElement("a");
                                                    enlace.href = `data:image/png;base64,${msg.imageContent}`;
                                                    enlace.download = "imagen-apa.png";
                                                    enlace.click();
                                                }}
                                            >
                                                <DownloadIcon size={18} />
                                            </Button>
                                        </Box>
                                    </Box>
                                )
                            }
                        </FadeAnimationText> */}
                    </>
                ))
            }
            {
                isLoading && (
                    <Box display={"flex"} gap={2} alignItems={"center"} height={200}>
                        <Avatar size='sm' name='Avianca Agent' src={LogoAv} bg={"black"} color={"white"} />
                        <Heading color={"black"} size={"sm"} fontWeight={"light"}>
                            <ShinyTextAgent text="Pensando..." />
                        </Heading>
                    </Box>
                )
            }
        </>
    )
}